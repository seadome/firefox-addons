---
name: CI
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Nix
        uses: cachix/install-nix-action@v18
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
      - name: Setup binary cache
        uses: cachix/cachix-action@v12
        with:
          name: seadome
          extraPullNames: dotfield nix-community
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - name: 'Update flake inputs'
        run: nix flake update --show-trace --verbose
      - name: 'Update Firefox addons manifest'
        run: |
          nix run --inputs-from . --print-build-logs --verbose --show-trace \
            mozilla-addons-to-nix -- ./src/addons.json ./src/addons.generated.nix
      - name: 'Commit and create pull request'
        uses: peter-evans/create-pull-request@v4
        with: 
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update all'
          title: 'Update flake inputs and addons'
          body: |
            Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
